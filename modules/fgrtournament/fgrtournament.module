<?php

/**
 * @file
 * A block module that displays recent blog and forum posts.
 */
function fgrtournament_help($path, $arg) {
  switch ($path) {
    case "admin/help#fgrtournament":
      return '' . t("Displays tournament bracket") . '';
      break;
  }
}

/**
 * Implements hook_node_info().
 */
function fgrtournament_node_info() {
  $items = array(
      'fgrtournament' => array(
          'name' => t('FGR tournament bracket'),
          'base' => 'node_content',
          'description' => t('Displays tournament bracket.'),
          'help' => 'Displays tournament bracket.',
      ),
  );
  return $items;
}

/**
 * Implements hook_node_view().
 */
function fgrtournament_node_view($node, $view_mode, $langcode)
{
    module_load_include('inc', 'fgrtournament', 'fgrtournament.api');
    switch ($node->type) {
        case 'fgrtournament':
            if(isset($_GET['tournament_id'])) {
                $tournament_id = $_GET['tournament_id'];
                $tournament_data = get_tournament_by_id($tournament_id);
                $node->content['fgrtournament_playoff'] = array(
                    "#markup" => theme('fgrtournament_playoff', array('tournament_data' => $tournament_data))
                );
            } else {
                $result = get_last_tournaments();
                $node->content['fgrtournament_list'] = array(
                    "#markup" => theme('fgrtournament_list', array('fgrtournaments' => $result, 'node' => $node))
                );
            }
            break;
    }
}

/**
 * Implements hook_theme();
*/
function fgrtournament_theme() {
    return array(
        'fgrtournament_list' => array(
            'variables' => array('fgrtournaments' => NULL, 'node' => NULL),
            'template' => 'templates/fgrtournament-list',
            'file' => 'fgrtournament.pages.inc',
        ),
        'fgrtournament_playoff' => array(
            'variables' => array('tournament_data' => NULL, 'node' => NULL),
            'template' => 'templates/fgrtournament-playoff',
            'file' => 'fgrtournament.pages.inc',
        ),
        'fgrtournament_table_sort' => array(
            'variables' => array('tournament_data' => NULL, 'node' => NULL),
            'template' => 'templates/fgrtournament-table-sort',
            'file' => 'fgrtournament.pages.inc',
        ),
        'fgrtournament_table_unsort' => array(
            'variables' => array('tournament_data' => NULL, 'node' => NULL),
            'template' => 'templates/fgrtournament-table-unsort',
            'file' => 'fgrtournament.pages.inc',
        ),
        'fgrtournament_table_without_result' => array(
            'variables' => array('tournament_data' => NULL, 'node' => NULL),
            'template' => 'templates/fgrtournament-table-without-result',
            'file' => 'fgrtournament.pages.inc',
        ),
        'fgrtournament_table_mini' => array(
            'variables' => array('tournament_data' => NULL, 'node' => NULL),
            'template' => 'templates/fgrtournament-table-mini',
            'file' => 'fgrtournament.pages.inc',
        )
    );
}

/**
 * @return predefined tournament node id
 */
function get_fgrtournament_node_id() {
    return db_select('node', 'id')
        ->fields('id')
        ->condition('type', 'fgrtournament', '=')
        ->execute()
        ->fetchAssoc();
}
